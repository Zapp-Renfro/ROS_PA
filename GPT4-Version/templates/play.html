<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Jouer la piste sélectionnée</title>
</head>
<body>
    <h1>Jouer la piste sélectionnée</h1>
    <div>
        <audio controls>
            <source src="{{ preview_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <div>
            <label for="nationality">Choisissez une nationalité:</label>
            <select id="nationality" name="nationality" onchange="fetchVoices()">
                <!-- Options de nationalité seront ajoutées ici dynamiquement -->
            </select>
        </div>
        <div>
            <label for="voices">Écoutez les voix:</label>
            <select id="voices" name="voices" onchange="playVoice()">
                <!-- Options de voix seront ajoutées ici dynamiquement -->
            </select>
        </div>
        <button onclick="useSelectedVoice()">Utiliser la voix sélectionnée</button>
        <form action="{{ url_for('final_video') }}" method="post">
            <input type="hidden" name="track_id" value="{{ track_id }}">
            <input type="hidden" name="preview_url" value="{{ preview_url }}">
            <input type="hidden" name="start_time" value="0">
            <input type="hidden" name="end_time" value="{{ video_duration }}">
            <input type="hidden" name="volume" value="1.0">
            <input type="hidden" name="selected_voice" id="selected_voice">
            <input type="submit" value="Créer une vidéo">
        </form>
    </div>
    <script>
        const nationalitySelect = document.getElementById('nationality');
        const voicesSelect = document.getElementById('voices');
        const selectedVoiceInput = document.getElementById('selected_voice');

        document.addEventListener('DOMContentLoaded', (event) => {
            fetchNationalities();
        });

        function fetchNationalities() {
            fetch('/get_nationalities')
                .then(response => response.json())
                .then(data => {
                    data.nationalities.forEach(nationality => {
                        const option = document.createElement('option');
                        option.value = nationality;
                        option.text = nationality;
                        nationalitySelect.appendChild(option);
                    });
                });
        }

        function fetchVoices() {
            const nationality = nationalitySelect.value;
            fetch(`/get_voices?nationality=${nationality}`)
                .then(response => response.json())
                .then(data => {
                    voicesSelect.innerHTML = '';
                    data.voices.forEach(voice => {
                        const option = document.createElement('option');
                        option.value = voice.id;
                        option.text = voice.name;
                        voicesSelect.appendChild(option);
                    });
                });
        }

        function playVoice() {
            const voiceId = voicesSelect.value;
            fetch(`/play_voice?voice_id=${voiceId}`)
                .then(response => response.json())
                .then(data => {
                    const audio = new Audio(data.audio_url);
                    audio.play();
                });
        }

        function useSelectedVoice() {
            const voiceId = voicesSelect.value;
            selectedVoiceInput.value = voiceId;
        }
    </script>
</body>
</html>
